---
title: "运输层——传输控制协议TCP（其一）"
date: 2022-10-30T19:58:30+08:00
draft: false
math: true

tags: ["计算机网络", "运输层", "TCP"]
categories: ""
description: ""
---

## 1、传输控制协议 TCP 概述

### 1.1、TCP 的主要特点

1.   **TCP 是面向连接的运输层协议。**必须先建立连接，再传送数据，最后断开连接。
2.   每一条TCP 连接只能有两个端点（endpoint），每一条 TCP 连接只能是**点对点**的。
3.   TCP 提供**可靠交付**的服务。无差错、不丢失、不重复、按序到达。
4.   TCP 提供**双全工通信**。
5.   **面向字节流**。TCP中的**“流”（stream）指的是流入和流出进程的字节序列**。TCP 把应用程序交下来的数据仅仅看成是一连串的无结构的字节流。TCP 并不知道所传送的字节流的含义。

一个 TCP 报文段通常包含上千个字节。TCP 连接是一条虚连接。

**虚连接（逻辑连接）**：并不是一条真正的物理连接，而是要依靠底层的协议实现，所以是虚连接。

### 1.2、TCP 的连接

TCP 把连接作为最基本的抽象。前面提到的端点叫作**套接字（socket）或插口**，即**端口号拼接到IP地址**。
$$
套接字 socket = （IP地址：端口号）
$$
**每一条连接唯一地被通信两端的两个端点所确定**。即：
$$
TCP 连接 ::= \{socket1, socket2\} = \{(IP1:port1), (IP2, port2)\}
$$

## 2、可靠传输的工作原理

### 2.1、停止等待协议

假设有一个端点发送数据，另一个端点接受数据，分别是A和B。A每次发送完一个分组后，就要等待B发来的确认。

有以下几种情况：

**1、无差错情况**：正常进行

**2、出现差错**

**超时重传**：A 只要超过了一段时间仍然没有收到确认，就认为刚才发送的分组丢失了，因而重传刚才发过的分组。

要设置一个超时计时器，每次发送都要设置计时器，如果在规定时间内收到确认就撤销。

细节问题：

1.   A 必须**暂时保留**没收到确认的分组。
2.   分组和确认分组都必须进行**编号**
3.   超时计时器的**重传时间**应当比平均往返时间长一些。

**3、确认丢失和确认迟到**

**确认丢失**：如果B给A发送的确认报文丢失了，A就会重传分组，B这时收到重复分组，**丢掉分组，重新发送确认**。

**确认迟到**：如果B发给A的确认报文遇到拥塞，超过了重传计时器的时间，A也会重发分组，B收到重复的分组也是**丢掉分组，重新发送确认**，A就会收到两份确认，**对于第二份确认，A什么也不会做**。

依靠上面的机制，就可以在不可靠的网络上提供可靠通信。而这种可靠传输协议常称为**自动重传请求ARQ（Automatic Repeat reQuest）**。

**4、信道利用率**

如果像上面说的那样，A发送一个分组，就等待一个确认分组，然后才能发送，那么信道的利用驴就会很低。

为了提高传输效率，发送方可以不使用停止等待协议，而是采用**流水线传输，发送方可以连续发送多个分组**。

### 2.2、连续ARQ协议

发送方维持一个**发送窗口**，位于发送窗口内的所有分组都可以发送，不必等待确认。

发送方每收到一个确认就把发送窗口向前滑动一个分组的位置。

接收方一般采取累计确认的方式，对于收到的分组，**对按序到达的最后一个分组发送确认**。

## 3、TCP 的报文段的首部格式

**TCP 传送的数据单元是报文段**。一个TCP报文段分为**首部和数据**两部分。TCP 的**前 20 字节是固定的**，后面 4n 字节根据需要增加。

1.   **源端口和目的端口**：各占 2 字节。
2.   **序号（seq）**：占 4 字节，序号循环使用，溢出模后再开始（mod $2^{32}$）。每一个字节都按序号编号，序号指的是本报文数据开始的序号，如果一段报文序号为301，数据长度为100，下个报文的序号为401。
3.   **确认号（ack）**：占 4 字节，**期望收到的下一个报文段的第一个数据字节的序号**。
4.   **数据偏移**：占 4 字节，指出报文数据起始处距离报文起始处的长度，**其实就是头部的长度，单位是 4 字节**。
5.   **保留**：6 位
6.   **紧急URG（urgent）**：1 位，URG = 1时有效，要插到最前面发送，配合紧急指针使用。
7.   **确认ACK（acknowledgment）**：1 位，当 ACK = 1 时，ack 才有效。所以，连接建立后，所有的报文都是 ACK = 1
8.   **推送PSH（push）**：1 位，设置为 PSH = 1后，发送方立即创建报文发送过去，接收方收到后，立即交付应用进程。
9.   **复位RST（reset）**：1 位，RST = 1时，说明连接出现了严重差错，必须释放再重新建立连接。也可以用于拒绝连接。
10.   **同步SYN（synchronization）**：1 位，连接建立时用来同步序号。SYN = 1，ACK = 0 表示请求建立连接，对方回复 SYN = 1,ACK = 1 表示同意。
11.   **终止FIN（finis）**：1位，FIN = 1 表示发送方的数据已经发送完毕，要求释放连接。
12.   **窗口（cwnd，window）**：占 2 字节。表示发送方的接受窗口，告诉对方，我还有多少空间可以接受数据（字节位单位）。
13.   **检验和**：2 字节，检验范围包括首部和数据，计算时，和UDP一样，需要在报文段前面加上12字节的伪首部。
14.   **紧急指针**：2 字节，只有 URG = 1 时才有意义，指出**紧急数据的字节数**。

上面 20 字节时固定的。

15.   选项：长度可变，最长40字节，最后填充只是为了让头部是4字节的整数倍。

**MSS（Maximum segment Size）**：每一个 TCP 报文段中**数据字段的最大长度**。

